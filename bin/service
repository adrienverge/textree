#!/usr/bin/env nodejs

var env = process.env;
var port = env.TEXTREE_HTTP_PORT || 8080;
var http = require("http");
var url = require("url");
var textree = require("../lib/textree");
var Q = require("q");


function processRequest(request, response) {
  var path = request.url.replace(/\?.*$/, "");

  Q.when(textree.getStream(path)).then(function(stream) {
    response.writeHead(200, {'Content-Type': stream.getContentType()});

    // console.log("req", req.url, url.parse(req.url));
    stream.pipe(response);
    response.end('Hello World\n');
  });

}


var server = http.createServer(processRequest);

try {
  server.listen(port);
}
catch (e) {
  console.log("could not bind to port:", port);
}
